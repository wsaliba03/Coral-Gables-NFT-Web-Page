<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City of Coral Gables Trees NFTs</title>
    <link rel="icon" href="favicon.jpg" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="navbar container-header col col-12" id="navigationBar">
                <a class="navbar-brand" id="navTitle" href="index.html">City of Coral Gables Trees NFTs</a>
                <nav class="nav-links" id="links">
                    <ul class="nav-item">
                        <li><a href="https://coralgables.com/department/public-works/tree-year-contest">About Us</a>
                        </li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="contact.html">Contact Us</a></li>
                    </ul>
                </nav>
            </div>
        </div>

        <div class="loader" id="loader"></div>
        <div class="nft-container" id="nft-container"></div>
        <div class="pagination">
            <button id="prevBtn" onclick="prevPage()">Previous</button>
            <button id="nextBtn" onclick="nextPage()">Next</button>
        </div>

        <script>
            const apiUrl = 'https://api.opensea.io/api/v2/collection/city-of-coral-gables-smart-contract-test-CrAKZ717H/nfts?limit=20';
            const apiKey = '2efc3fd5dfba4877b385ce380c054192';
            let currentPage = 0;
            const pageSize = 4;
            let filteredNFTs = [];

            async function fetchNFTs() {
                document.getElementById('loader').style.display = 'block';
                try {
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'x-api-key': apiKey
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();
                    filteredNFTs = data.nfts.filter(nft => ![
                        'Coral Gable Oak Tree',
                        'City of Coral Gables Smart Contract Test'
                    ].includes(nft.name));
                    filteredNFTs = filteredNFTs.filter(nft => ![
                        '12'
                    ].includes(nft.identifier));
                    displayNFTs();
                } catch (error) {
                    console.error('Error fetching NFTs:', error);
                } finally {
                    document.getElementById('loader').style.display = 'none';
                }
            }

            function displayNFTs() {
                const container = document.getElementById('nft-container');
                container.innerHTML = '';

                const start = currentPage * pageSize;
                const end = start + pageSize;
                const nftsToDisplay = filteredNFTs.slice(start, end);

                nftsToDisplay.forEach(nft => {
                    const nftItem = document.createElement('div');
                    nftItem.className = 'nft-item';

                    let cleanedName = nft.name.replace(/Coral Gables?\s*/gi, '').trim();
                    
                    // Check if the name doesn't end with "Tree" and add it if necessary
                    if (!cleanedName.toLowerCase().endsWith('tree')) {
                        cleanedName += ' Tree';
                    }

                    nftItem.innerHTML = `
                    <img src="${nft.image_url}" alt="${cleanedName}">
                    <h4 class="card-title">${cleanedName}</h4>
                    <button onclick="reserveNFT('${nft.identifier}', '${nft.contract}')">Reserve NFT</button>
                    <button onclick="openOpenSea('${nft.opensea_url}')">View on OpenSea</button>
                `;

                    container.appendChild(nftItem);
                });

                document.getElementById('prevBtn').disabled = currentPage === 0;
                document.getElementById('nextBtn').disabled = end >= filteredNFTs.length;
            }

            function prevPage() {
                if (currentPage > 0) {
                    currentPage--;
                    displayNFTs();
                }
            }

            function nextPage() {
                if ((currentPage + 1) * pageSize < filteredNFTs.length) {
                    currentPage++;
                    displayNFTs();
                }
            }

            async function reserveNFT(tokenId) {
                const userAddress = prompt("Please enter your wallet address:");
                if (!userAddress) {
                    alert("Wallet address is required to reserve the NFT.");
                    return;
                }

                try {
                    const approveResponse = await fetch('http://localhost:3000/approve', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            tokenAddress: '0xb518fdcf0e8285eade313798445f74918d68eaf2', // Replace with your actual token address
                            operatorAddress: userAddress
                        })
                    });

                    const approveData = await approveResponse.json();

                    if (!approveResponse.ok) {
                        throw new Error('Error approving NFT: ' + (approveData.error || approveData.message || 'Unknown error'));
                    }

                    const transferResponse = await fetch('http://localhost:3000/transfer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            operatorAddress: userAddress,
                            tokenAddress: '0xb518fdcf0e8285eade313798445f74918d68eaf2', // Replace with your actual token address
                            tokenId: tokenId,
                            amount: '1'
                        })
                    });

                    const transferData = await transferResponse.json();

                    if (transferResponse.ok) {
                        alert('NFT reserved and transferred successfully! Transaction Hash: ' + transferData.transferHash);
                    } else {
                        throw new Error('Error transferring NFT: ' + (transferData.error || transferData.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error reserving and transferring NFT:', error);
                    alert('Error: ' + error.message);
                }
            }

            function openOpenSea(openseaUrl) {
                window.open(openseaUrl, '_blank');
            }

            window.onload = fetchNFTs;
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>